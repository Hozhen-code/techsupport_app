{% extends "base.html" %}
{% block title %}메뉴얼{% endblock %}

{% block content %}
<style>
  /* 페이지 전용(다른 화면과 충돌 방지) */
  #manuals .layout{display:grid;grid-template-columns:260px 1fr;gap:16px}
  #manuals .left{background:#f5f7fb;padding:12px;overflow:auto;border-radius:8px}
  #manuals .right{padding:12px;overflow:auto}
  #manuals .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  #manuals .tree ul{list-style:none;padding-left:18px}
  #manuals .node-row{display:flex;align-items:center;gap:6px}
  #manuals .tri{width:14px;text-align:center;display:inline-block;cursor:pointer}
  #manuals .pill{display:inline-block;padding:3px 8px;margin:2px;border-radius:12px;background:#e7eefc;cursor:pointer}
  #manuals .pill.active{background:#d0defc;font-weight:600}
  #manuals .muted{color:#6b7280;font-size:12px}
  #manuals .search{width:100%;padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px}
  #manuals .sticky-top{position:sticky;top:0;background:#f5f7fb;padding-bottom:8px}
</style>

<div id="manuals" class="container">
  <h2>메뉴얼</h2>

  <div class="layout">
    <!-- 왼쪽 패널 -->
    <aside class="left">
      <div class="sticky-top">
        <div style="margin-bottom:8px">
          <label class="muted">버전</label>
          <select id="version" style="width:100%;padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px">
            {% for v in versions %}
              <option value="{{ v.id }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom:8px">
          <label class="muted">SW (다중선택)</label>
          <div id="sw-box">
            {% for s in software %}
              <span class="pill" data-id="{{ s.id }}">{{ s.name }}</span>
            {% endfor %}
          </div>
        </div>

        <input id="q" class="search" placeholder="검색(트리에서 일치 항목 펼치기)" />
        <div class="toolbar" style="margin-top:8px">
          <button class="btn" id="expand">+ 모두 펼치기</button>
          <button class="btn" id="collapse">- 모두 접기</button>
        </div>
      </div>

      <div class="tree" id="tree"></div>
    </aside>

    <!-- 오른쪽 본문 -->
    <main class="right">
      <div class="toolbar">
        <button class="btn btn-primary" id="export">PDF 내보내기</button>
        <span class="muted">선택 노드 상세/첨부 업로드는 아래에서</span>
      </div>

      <div id="detail">
        <p class="muted">좌측 트리에서 항목을 클릭하면 상세가 여기에 표시됩니다.</p>
        <div id="detail-inner"></div>
      </div>
    </main>
  </div>
</div>

<script>
(function(){
  const versionEl = document.getElementById('version');
  const swBox = document.getElementById('sw-box');
  const treeEl = document.getElementById('tree');
  const searchEl = document.getElementById('q');
  const expandBtn = document.getElementById('expand');
  const collapseBtn = document.getElementById('collapse');
  const exportBtn = document.getElementById('export');

  // SW pill 클릭 토글
  function selectedSW(){
    return Array.from(swBox.querySelectorAll('.pill.active')).map(p=>p.dataset.id);
  }
  swBox.addEventListener('click', (e)=>{
    const t = e.target.closest('.pill'); if(!t) return;
    t.classList.toggle('active'); loadTree();
  });

  // 검색/버전 변경
  searchEl.addEventListener('input', debounce(loadTree, 300));
  versionEl.addEventListener('change', loadTree);

  // 접기/펼치기
  expandBtn.addEventListener('click', ()=>treeEl.querySelectorAll('ul').forEach(u=>u.style.display='block'));
  collapseBtn.addEventListener('click', ()=>treeEl.querySelectorAll('ul').forEach(u=>u.style.display='none'));

  // PDF
  exportBtn.addEventListener('click', async ()=>{
    const sw = selectedSW();
    if(!sw.length){ alert('SW를 선택해주세요'); return; }
    const fd = new FormData();
    fd.append('version_id', versionEl.value);
    fd.append('sw_ids', sw.join(','));
    fd.append('cover_title', '메뉴얼');
    const res = await fetch('/manuals/export/pdf', {method:'POST', body: fd});
    if(!res.ok){ alert('내보내기 실패'); return; }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='manual.pdf'; a.click();
    URL.revokeObjectURL(url);
  });

  // 트리 로드
  async function loadTree(){
  const sw = selectedSW();
  const q  = searchEl.value || '';
  if(!sw.length){
    treeEl.innerHTML = '<p class="muted">좌측에서 SW를 하나 이상 선택하세요.</p>';
    return;
  }
  const res = await fetch('/manuals/api/tree', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      version_id: Number(versionEl.value),
      sw_ids: sw.map(Number),
      q
    })
  });
  if(!res.ok){
    const t = await res.text(); alert('트리 로드 실패\n' + t); return;
  }
  const data = await res.json();
  renderTree(data.tree);
  }

  function renderTree(tree){
    treeEl.innerHTML = '';
    const ul = document.createElement('ul');
    treeEl.appendChild(ul);
    tree.forEach(n => ul.appendChild(renderNode(n)));
  }

  function renderNode(n){
    const li = document.createElement('li');
    const row = document.createElement('div');
    row.className = 'node-row' + (n.highlight ? ' hit' : '');
    const tri = document.createElement('span');
    tri.className='tri';
    tri.textContent = (n.children && n.children.length) ? '▸':'';
    const cb = document.createElement('input');
    cb.type='checkbox';
    cb.indeterminate = (n.state==='partial');
    cb.checked = (n.state==='checked');
    const label = document.createElement('span');
    label.textContent = n.title; label.style.cursor='pointer';
    row.appendChild(tri); row.appendChild(cb); row.appendChild(label);
    li.appendChild(row);

    const kids = document.createElement('ul'); kids.style.display='none';
    li.appendChild(kids);

    if(n.children && n.children.length){
      tri.addEventListener('click', ()=>{
        kids.style.display = (kids.style.display==='none' ? 'block' : 'none');
        tri.textContent = kids.style.display==='none' ? '▸' : '▾';
      });
      n.children.forEach(c => kids.appendChild(renderNode(c)));
    }

    label.addEventListener('click', ()=>showDetail(n));

    cb.addEventListener('change', async ()=>{
      const sw = selectedSW();
      const res = await fetch('/manuals/api/check', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          version_id: Number(versionEl.value),
          sw_ids: sw.map(Number),
          node_id: Number(n.id),
          checked: !!cb.checked
        })
      });
      if(!res.ok){
        const t = await res.text(); alert('저장 실패\n' + t); return;
      }
      loadTree();
    });
    
    return li;
  }

  async function showDetail(n){
    const wrap = document.getElementById('detail-inner');
    wrap.innerHTML = `
      <h3>${n.title}</h3>
      <form id="upform">
        <div style="margin:8px 0">
          <label>첨부 업로드(PDF/Word/이미지)</label>
          <input type="file" name="file" />
        </div>
        <div style="display:flex;gap:8px">
          <select name="software_id" id="softSel"></select>
          <button class="btn">업로드</button>
        </div>
      </form>
    `;
    const softSel = wrap.querySelector('#softSel');
    for(const s of selectedSW()){
      const opt = document.createElement('option');
      const pill = document.querySelector(`.pill[data-id="${s}"]`);
      opt.value = s; opt.textContent = pill ? pill.textContent : s;
      softSel.appendChild(opt);
    }
    wrap.querySelector('#upform').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      fd.append('version_id', versionEl.value);
      fd.append('node_id', n.id);
      const res = await fetch('/manuals/api/upload', {method:'POST', body: fd});
      if(!res.ok){ alert('업로드 실패'); return; }
      alert('업로드 완료');
    });
  }

  function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }

  // 초기: 첫 1~2개 SW pill을 기본 선택해주면 빈 화면 방지
  (function primeSW(){
    const pills = swBox.querySelectorAll('.pill');
    for(let i=0;i<Math.min(2,pills.length);i++){ pills[i].classList.add('active'); }
  })();

  loadTree();
})();
</script>
{% endblock %}
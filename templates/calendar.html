{% extends "base.html" %}
{% block title %}캘린더 - NAIZ{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-2">캘린더</h1>

<div class="card mb-2">
  <div class="card-body">
    <div class="form-row">
      <div>
        <label>현장</label>
        <select id="fSite" class="form-control">
          <option value="">전체</option>
          {% for sid, sname in sites %}
            <option value="{{ sid }}">{{ sname }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>담당자</label>
        <select id="fAssignee" class="form-control">
          <option value="">전체</option>
          {% for eid, ename in employees %}
            <option value="{{ eid }}">{{ ename }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>상태</label>
        <select id="fStatus" class="form-control">
          <option value="">전체</option>
          {% for st in statuses %}
            <option value="{{ st }}">{{ st }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>검색</label>
        <input id="fQ" class="form-control" placeholder="내용/현장명">
      </div>
      <div style="align-self:end">
        <button id="btnReload" class="btn btn-outline">적용</button>
        <a class="btn btn-primary" href="/cs_schedules/new">+ 일정 등록</a>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div id="calendar"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function buildQuery(params) {
    const usp = new URLSearchParams();
    Object.entries(params).forEach(([k, v]) => { if (v !== undefined && v !== null && v !== "") usp.set(k, v) });
    return usp.toString();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'ko',
      initialView: 'dayGridMonth',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      navLinks: true,
      eventSources: [{
        events: function(info, success, failure){
          const qs = buildQuery({
            start: info.startStr,
            end: info.endStr,
            site_id: document.getElementById('fSite').value,
            assignee: document.getElementById('fAssignee').value,
            status: document.getElementById('fStatus').value,
            q: document.getElementById('fQ').value
          });
          fetch('/api/events?' + qs)
            .then(r => r.json())
            .then(data => success(data))
            .catch(err => failure(err));
        }
      }],
      eventClick: function(info){
        const p = info.event.extendedProps || {};
        alert(
          `[${p.status || ''}] ${info.event.title}\n` +
          `시작: ${info.event.startStr}\n종료: ${info.event.endStr}\n담당: ${(p.assignees || []).join(', ')}`
        );
      }
    });

    calendar.render();
    document.getElementById('btnReload').addEventListener('click', () => calendar.refetchEvents());
  });
</script>
{% endblock %}
